################################################################################

GSAC-WS Installation

README, Part 1.  Creating the Initial GSAC Server at your repository

October 3, 2013.  SKW UNAVCO

This README file describes the first steps in GSAC installation, and is the first of two README files detailing GSAC installation.  
This README file is "README Part 1," and is in gsac-code/src/org/gsac/ in the GSAC package available from SourceForge as described below.

UNAVCO's GSAC-WS, called GSAC, is a package of code for web services. With GSAC a geodesy or geophysics data center can quickly offer a set of complete, 
consistent, modern web services for remote users to query the data center about stations and instruments, and download data files. 

The UNAVCO GSAC-WS home page is at http://facility.unavco.org/data/gsacws/gsacws.html. 
The GSAC Web Services document, "UNAVCO GSAC WS: Web Services for Geodesy Data Repositories" (http://facility.unavco.org/data/gsacws/docs/UNAVCO_GSAC_Web_services.pdf)
introduces GSAC.  The GSAC User Guide "UNAVCO GSAC WS: User Guide for GSAC Data Repositories" (http://facility.unavco.org/data/gsacws/UNAVCO_GSAC_User_Guide.pdf)
is for persons using data repositories powered by GSAC.

################################################################################

Installing GSAC Web Services -- What You Need

You can install GSAC web services for a data repository when you have:

    a database, with complete metadata about sites(stations), their instruments, and their data files (if any). GSAC presently can read Oracle, Postgres, or MySQL. You can use an existing database you have, with no changes to it -- but some changes will be needed to GSAC code to be able to read the database. Or you can make a new database using the GSAC prototype database schema (as described below), populating it with your data values. See more in The GSAC Database, below.

    usually, but optionally, data files from the instruments for remote users to download. GSAC can provide discovery and download of geodesy data files like RINEX files.

    if you want to offer data file downloads, an FTP / HTTP download server the data files. GSAC does not download files. GSAC tells users how and where to download files. For example, GSAC can run on a web server different from one or more servers for downloads, a benefit.

    a web server for GSAC web pages. Running GSAC with the Tomcat application server is common, but Tomcat is optional. GSAC can use its own included application server, Jetty.

    the GSAC software package provided by UNAVCO. GSAC is free and open source code in the GSAC package from SourceForge.

    A Linux system for the initial installation and test of GSAC, with related software tools bash, Java JDK 1.6 or 1.7, subversion ("svn"), and ant, and with access to your GSAC database.

A typical Linux system for the initial installation and test of GSAC could be Ubuntu, version 11, 12 or 13. Use the bash shell.
Ubuntu with bash has very simple installation of the software tools you need.

Java version 1.6 or 1.7 works. Ubuntu may come with Java JDK which is all you need for GSAC builds. If your system lacks Java, or to upgrade to Java (JDK) 1.7, do:
sudo apt-get install openjdk-7-jdk
sudo update-alternatives --config java       Choose the item for the Java version you want.
In ~/.bashrc, add
export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-i386
and do command source ~/.bashrc

To install ant, do command sudo apt-get install ant

To install subversion ("svn"), do command sudo apt-get install subversion

If you elect to use MySQL (see below), versions 5.1 to 5.5 work. Do the command sudo apt-get install mysql-server
This requests a you to enter a new so-called "root" password for MySQL use, which is a new password, not your Linux system root password.

################################################################################

The GSAC Database

An essential part of GSAC installation and operations, which is not available from online resources, is a database which you create and maintain, about sites (stations), their instruments, and their data files (if any). The GSAC database contains the information about stations which you wish to offer online, and about stations' data files which you wish to offer for download. The database must contain up-to-date, complete, and correct information if GSAC services are to represent your data repository correctly. (The GSAC database is also a good way to manage contents of your data repository, aside from GSAC operations, if it is well designed. To manage a data center, a well-designed database is much less error prone, and much more suited to computer operations, than text files such as IGS site logs or SINEX files.)

There are two ways to supply a database for GSAC. First, you can use an existing Oracle, Postgres, or MySQL database about your data holdings and stations, if it has the database fields used by GSAC. See the Prototype GSAC database schema (MySQL form) at http://facility-beta-web-server.win.int.unavco.org/data/gsacws/docs/Prototype_GSAC_Database_MySQL_schema_notes.txt. This set of parameters enables GSAC to provide its complete suite of web services for searching for geodesy stations information and for station instrument data files, and for data file downloads by GSAC. This list is provided so that persons considering GSAC may see if they have adequate types of metadata in an exisiting database to support GSAC web services. In general the fields which may be NULL in the database are not required for GSAC operations. This schema is for MySQL but the parallel to Postgres and Oracle should be clear.

Or, second, you can create a new a database for GSAC for your data center. UNAVCO supplies a standard or prototype GSAC database in MySQL (a schema in a MySQL .sql or dump file). The schema supports geodesy data search and discovery, and all the GSAC formats of search results including web pages, and SINEX and GAMIT station.info files. You can download the MySQL schema .sql file 
Prototype_GSAC_Database.sql (http://facility-beta-web-server.win.int.unavco.org/data/gsacws/docs/Prototype_GSAC_Database.sql) for the prototype GSAC database (a MySQL "dump file"). (You can look at this MySQL file in your browser too: click on it.) This prototype schema may be revised in future, but it is quite complete now.

The tables and fields (columns) in the prototype GSAC schema show the essential parameters needed for GSAC, and their data types. The prototype design corresponds to common geodesy needs, such as encapsulating station receiver-antenna sessions, and helps avoid error-prone database practices, such as storing latitude values or time values in a character strings. The prototype design includes features to insure reduced problems in an archive database. For example, only actual dates and numbers can be stored in date and number fields. Databases which store dates or numbers as character strings are error-prone and difficult to manage. GSAC uses all times and dates in UTC, in ISO 8601 format.

To create a new MySQL GSAC prototype database using that .sql file:
- if you do not have MySQL, install it. On some Linux systems you can simply do the command sudo apt-get install mysql-server. This requests a you to enter a new so-called "root" password for MySQL use, which is a new password, not your Linux system root password.
- start the MySQL server, for example in Linux with "sudo /etc/init.d/mysql restart"
- cd to the folder with the file Prototype_GSAC_Database.sql
- edit the .sql file to change the name of the database, before you use mysql to create the database. You can change all instances of `Prototype_GSAC_Database` to your new db name, something like MyCenter_GSAC_database; the name is not particularly important and will not be publically visible.
- run mysql as mysql root and create a new MySQL account for GSAC, called for example gsac
- run the mysql command line tool, such as, in Linux, "mysql -u gsac -p"
(MySQL documentation is online, as at http://dev.mysql.com/doc/refman/5.1/en/index.html).
- in mysql (mysql>) do the command source Prototype_GSAC_Database.sql; (including the ;)

This creates a GSAC prototype MySQL database, which is of course initially empty of your GNSS metadata. You can use mysql commands to explore the new database schema.

You need to populate the database with the information about your stations, instruments, and instrument data files. UNAVCO has a script to populate the GSAC prototype database with information about geodesy data files you already have on an FTP or HTTP site. UNAVCO is creating a script to populate a GSAC prototype database from a SINEX file (which may be tricky to use). If you use the GSAC prototype database design, you can email UNAVCO to get whatever version of these scripts we have to help you populate your database. The scripts are written in Python.

UNAVCO is very happy to aid and advise about GSAC installations and operations. UNAVCO has a responsibility to ensure that GSAC itself installs properly. UNAVCO can help install GSAC, in some cases, by providing a provisional working database with some of your data center's information, if some conditions are met including your use of the provisional database schema.

UNAVCO does not populate your database beyond an initial set of data to ensure GSAC is working. Populating your database, and maintaining it, is necessary to operate GSAC, but doing so is entirely outside of GSAC itself -- see the diagram on the GSAC web home page-- and is your responsibility. Likewise GSAC does not provide services to check data quality or otherwise manage a data archive. GSAC is web services; it does not "know" (much) about geodesy.


################################################################################

Installing the GSAC Web Services Software Package
Part 1.  Creating the initial GSAC Server at your repository

################################################################################

Quick Install for Part 1.  
For experienced GSAC operators and software engineers.

Find or make a top-level working directory for GSAC, and go there. For example:

mkdir ~/GSAC/

cd    ~/GSAC/

Check out the GSAC code from SourceForge 
   (to get this command, go to https://sourceforge.net/projects/gsac/ and click on 'Code' menu item in 'Summary Files ...' menu line)
by entering this command:

svn checkout svn://svn.code.sf.net/p/gsac/code/trunk gsac-code

The svn checkout creates a new folder gsac-code and many folders and files in it.

cd gsac-code/

Note the files in this new folder; one is a copy of the prototype GSAC database in a MySQL .sql file.

Do an intial ant build with the command:

ant


Next, edit 

gsac-code/src/org/gsac/gsl/htdocs/repositorymap.js 

to set the longitude, latitude, and zoom level for the center of your map in the lines:
The value defaultZoomLevel = 4 will show all of western Europe; 6 will show an area about 1200 km wide by 800 km high. 

  var defaultLocation = new OpenLayers.LonLat(14.15, 48.5);
  var defaultZoomLevel = 5;

Rebuild the GSAC core code with command 'ant', executed in ~/GSAC/gsac-code/.  You may find the screen messages interesting to show the 
process of a GSAC build. 

Next

cd  ~/GSAC/gsac-code/src/org/gsac/template/

and replace "myrepo" in the new file name with an appropriate name for your repository.

cp macros.properties   myrepomacros.properties  

Edit the new myrepomacros.properties file to set:

target.name=Myrepo GSAC Repository
target.basename=gsacmyrepo     // used in Java package name and for the new directory for your new GSAC code files.
target.package=org.myrepo.gsac // The Java package name. If not beginning with org, see notes below for the Java package name.
target.prefix=Myrepo           // used in names of Java files. Java style has first letter in uppper case, only.
target.dbdriver=mysql.jar      // or postgres.jar or oracleDriver.jar; which db server type you use.

Then

cd ../   

to src/org/gsac/. Then run a command like this, with the new macros.properties file name:

BE SURE to use your new file name, not myrepomacros.properties:

ant -propertyfile template/myrepomacros.properties makerepository   

Look to be sure no errors are sent to the screen.  

This process creates a new code area, beginning with a new folder, something line
gsac-code/src/org/myrepo/gsac/ 
and populates it with initial all-new files for your GSAC repository.

cd to the just-made new directory with new GSAC code just for your repository, such as gsac-code/src/org/myrepo/gsac/. 

Follow the README file there to complete your GSAC installation. That is README Part 2. 

(end of quick install README Part 1).


################################################################################ ################################################################################

Complete GSAC installation instructions for  Part 1.

[some parts may be obsolete compared to the correct Quick install guidance, above.]

Check out GSAC code from SourceForge

Usually, you  make a new top-level working directory for GSAC, and go there. For example:

mkdir ~/GSAC/
cd    ~/GSAC/

(You can install GSAC code anywhere, so you need not make a new directory GSAC/.)

In the directory where you will install GSAC, such as ~/GSAC/, check out the GSAC code from SourceForge, using this svn (subversion) command:
(Go to https://sourceforge.net/projects/gsac/; and click on 'Code' menu item in 'Summary Files ...' menu line, to get the command below.)

svn checkout svn://svn.code.sf.net/p/gsac/code/trunk gsac-code

The download may take as long as 20 minutes, depending on your Internet connection speed.
This svn command creates the new subdirectory "gsac-code" and files under it. 

cd   gsac-code/




Build core GSAC code:

Next, 
cd   ~/GSAC/gsac-code/

Do the command "ant" which builds all the core GSAC code:

ant

(ant uses the build.xml in its directory, and may use other build.xml files further down the directory tres, such as the file  gsac-code/org/src/gsac/build.xml.)

This ant command builds the core GSAC code, including the GSL, the GSAC service layer.  

This may take one to three minutes. Watch for errors sent to the screen.  The screen output ends with something like this:

localinit:
init:
war:
     [copy] Copying 1 file to /home/mydir/gsac/gsac-code/dist
   [delete] Deleting:         /home/mydir/gsac/gsac-code/dist/gsacea1.0/servlet-api.jar
      [war] Building war: /home/mydir/gsac/gsac-code/dist/gsacws.war
     [echo] ********************************
     [echo] To run the test     server do the command:
     [echo] ant runserver
     [echo] ********************************
BUILD SUCCESSFUL
Total time: 1 minute 25 seconds

The ant build also will create these items in gsac-code/:
build.xml   dist/   examples/   lib/    README  src/
If you investigate you will find dozens of new files and directories below gsac-code/.

The core GSAC code is files in gsac-code/src/org/gsac/ and its subdirectories. 

Building core GSAC code makes the .jar file gsac-code/lib/gsacws.jar (and other things).
The file gsacws.jar holds all the core GSAC code.  When you build code for your local GSAC, described in README part 2, the core GSAC code is
imported or included in the gsacws.war file.  

In general you modify files in the core GSAC code only rarely if ever.  If you change a file there,
rebuild the GSAC core code with command ant in gsac-code/. Then rebuild your GSAC code
with ant in your GSAC area, if you have made the GSAC code particular to your repository.

(If you later change code, or get new files with an svn update for
new core GSAC code made by others (not already in your own personal GSAC), you need to do ant in gsac-code/ again to rebuild the core GSAC package.
Then rebuild your GSAC with ant in your lcoal directory area, as described below.)

Contact UNAVCO if you have or need changes to core GSAC code, such as format changes in an output ("GSAC results") file.

################################################################################

Center the GSAC Site Map

There is one routine case when you modify GSAC core code checked out from SourceForge.
Site search results from GSAC include a map for the site location. The map is made using OpenLayers. 
The default map in GSAC shows (at this time) almost all of western Europe, east to Moscow and Turkey.

To center the map in the latitude-longitude region for your geodesy network, edit 

gsac-code/src/org/gsac/gsl/htdocs/repositorymap.js

Set the longitude, latitude, and zoom level for the center of your map in the lines:

/*   center of GSAC map  or viewpoint, with longitude, latitude: */
/*   current GSAC default map center longitude, latitude:  14.15 E 48.5 N */
var defaultLocation = new OpenLayers.LonLat(14.15, 48.5);

Set the zoom level in the lines:

/*   GSAC map of sites; set zoom level: 3 is about 10,000 km wide; 4 is about 3900 km wide. */
var defaultZoomLevel = 4;

For more about OpenLayers maps, see for example http://trac.osgeo.org/openlayers/wiki/SettingZoomLevels.

Rebuild the GSAC core code with command ant in gsac-code/trunk/.  


################################################################################


The GSAC Core Code

Core GSAC code is in ~/GSAC/gsac-code/src/org/gsac/  

The full path including for example ~/GSAC/gsac-code/src/org/, is not shown in all commands here.

What's in src/org/gsac/:
 
   build.xml  used by ant 

   client/  The code files for the Java-based client program for accessing a GSAC repository using its API

   federated/ This is the implemention of the federated repository

   gsl/ This directory has the core GSAC Service Layer implementation files

   package.html for the web pages

   ramadda/ The files for the RAMADDA GSAC plugin, for the RAMADDA content management system (not described here)

   README   Part 1 for GSAC installation  (the file you are reading)

   template/  see the next section. 

################################################################################


Generating Your Initial GSAC-WS repository package

The template directory (org/gsac/template/) holds template files for the initial GSAC repository package 
implementation. This allows you to generate a new GSAC instance or package with all of the boilerplate Java code and build scripts.

What you need to do next is define a set of macro values that are used to take files in 
org/gsac/template/ and make an initial collection of code for your new GSAC data repository.

Copy the example org/gsac/template/macros.properties file to your own file with a similar name, e.g.:

cd to org/gsac/template/

cp macros.properties   myrepomacros.properties

'myrepo' is only a placeholder in this README file.  You replace "myrepo" with an appropriate name for your agency, project, or repository. 

Edit the new properties file to define the target package name, directory, etc.  For example:

##Name you want for the repository
target.name=Myrepo GSAC Repository

##This is used to create the jar and Tomcat's ".war" release file names. Often begins with the 4 characters "gsac," and ends with your acronym.
target.basename=gsacmyrepo

##target Java package name.  Replace the 'myrepo' part with your acronym, and retain the org. and .gsac parts:
target.package=org.myrepo.gsac

(You may wish to choose a top-level Java package name other than "org."  For example, if you wish to have the top level be "de", 
first make a new subdirectory gsac-code/src/de/.  Then in your  macros.properties file use 
target.package=de.myrepo.gsac
You may use longer package names, such as the GSAC package at edu.ucsd.sopac.projects.gsac.repository from SOPAC at the University of California San Diego.
)

A correct target.package name is important.  It determines the directories where your GSAC code is stored.  If there is an error in the target.package
the files will be in the wrong place in the GSAC tree and your code will not compile or build correctly. Do not put your package in the core area src/org/gsac/.

##All of the Java classes will have this prefix as the first part of their names, usually your acronym. Capitalize the first letter, a Java class naming convention.
target.prefix=Myrepo

# What database driver jar file do you use? (This gets added to the generated build.xml to include the right jar file from Java for db access.)
target.dbdriver=mysql.jar

Other choices for the database driver jar file, mysql.jar, are postgres.jar and oracleDriver.jar.  Use the one for your database.


Create initial code for new repository

cd ../ to src/org/gsac/

and run this ant command, replacing the 'myrepomacros.properties' file name with the name of your new properties file:

ant -propertyfile template/myrepomacros.properties makerepository   


The final lines output to screen from ant should be like:
init:
copyjava:
     [copy] Copying 1 file to ~/gsac/gsac-code/src/org/myrepo/gsac
     [echo] Repository source package has been created
BUILD SUCCESSFUL
Total time: 1 second

The 'myrepomacros.properties' file is only used this one time.

This ant makerepository process copies GSAC source and resource file templates to new directories and files, replacing the macros with
the values you defined in myrepomacros.properties, into the specified new package's directory tree, such as org/myrepo/.   This is 
somewhat parallel to the core GSAC code files in org/gsac/.


################################################################################


GSAC Code for a new Repository

After you created your myrepomacros.properties file, cd to the new directory with your GSAC code, such as 
~/GSAC/gsac-code/src/org/myrepo/gsac.  This is determined by your package name.  

(In the GSAC README files the path to your GSAC code is given as src/org/myrepo/, but your real path may not even have "org" of course. It could be
something like this ficticious path fr/paris-sorbonne/geocentre/projets/gsac/repository/. )

For a new implementation called myrepo, there are new files like these in the top directory with your GSAC code: 

   9851 2013-02-13 11:38 build.xml
   4096 2013-02-13 11:38 dbresources
    520 2013-02-13 11:38 gsacrepository.bat
    802 2013-02-13 11:38 gsacrepository.sh
    779 2013-02-13 11:38 package.html
  38199 2013-02-13 11:38 README
   4096 2013-02-13 11:38 release
   4096 2013-02-13 11:38 resources
   2046 2013-02-13 11:38 MyrepoDatabaseManager.java
   5299 2013-02-13 11:38 MyrepoFileManager.java
   2443 2013-02-13 11:38 MyrepoRepository.java
   1666 2013-02-13 11:38 MyrepoServer.java
  11231 2013-02-13 11:38 MyrepoSiteManager.java
   3440 2013-02-13 11:38 MyrepoTest.java

The new README file is README, Part 2, for your repository.  It has the next set of instructions for you to follow to complete your GSAC installation.  

Follow the instructions in the README the top directory with your GSAC code.

################################################################################

Build a Federated GSAC:

(NOT done as part of a GSAC to offer web services for your local data repository)


To install a federated GSAC, a single GSAC server which merges searches and results from
two or more other GSAC repositories, modify the file

gsac-code/src/org/gsac/federated/resources/gsacserver.properties

You connect to other GSACs in the file:

# Server info
gsac.server.hostname=repodev.unavco.org
gsac.server.port=80

#The list of remote server ids we are using

#For each of these the federated repository looks for:
#gsac.federated.<id>.url=base gsac url
#gsac.federated.<id>.name=repository name
#gsac.federated.<id>.icon=url to icon for the repository

gsac.federated.servers=unavcodev,sopac,cddis

gsac.federated.unavcodev.url=http://repodev.unavco.org/gsacws
gsac.federated.unavcodev.name=UNAVCO GSAC Repository
gsac.federated.unavcodev.icon=http://www.unavco.org/favicon.ico

gsac.federated.cddis.url=http://cddis.gsfc.nasa.gov/gsacws
gsac.federated.cddis.name=CDDIS GSAC Repository
gsac.federated.cddis.icon=http://cddis.nasa.gov/favicon.ico

gsac.federated.sopac.url=http://geogsac.ucsd.edu:8080/gsacws
gsac.federated.sopac.name=SOPAC GSAC Repository
gsac.federated.sopac.icon=http://sopac.ucsd.edu/favicon.ico

You may wish to extend the web page files
cd gsac-code/src/org/gsac/federated/
resources/header.html
resources/footer.html
package.html


################################################################################

end of README Part 1 for GSAC installation.

Copyright (C) 2013 UNAVCO.

################################################################################
